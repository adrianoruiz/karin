<!-- qrPage.html -->
<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code - Login no WhatsApp</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background-color: #f0f2f5;
        font-family: Arial, sans-serif;
      }

      #container {
        text-align: center;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      #loader {
        margin: 20px auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #qrCodeImage {
        display: none;
        margin: 20px 0;
        max-width: 100%;
        height: auto;
      }

      #instructions {
        font-size: 14px;
        color: #333;
        line-height: 1.6;
      }

      #retryMessage {
        display: none;
        color: #e74c3c;
        margin-top: 15px;
      }

      /* Estilos para modo de debug */
      .debug-mode {
        margin-top: 20px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #ddd;
      }

      .debug-mode h3 {
        margin-top: 0;
        color: #2c3e50;
      }

      #qrDebugImage {
        margin: 15px 0;
        max-width: 100%;
        height: auto;
      }
      
      .btn {
        display: inline-block;
        padding: 10px 15px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 15px;
        text-decoration: none;
      }
      
      .btn:hover {
        background-color: #2980b9;
      }
      
      .btn-danger {
        background-color: #e74c3c;
      }
      
      .btn-danger:hover {
        background-color: #c0392b;
      }
      
      .status-message {
        margin-top: 15px;
        padding: 10px;
        border-radius: 4px;
        font-size: 14px;
      }
      
      .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .status-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="loader"></div>
      <img id="qrCodeImage" src="" alt="QR Code para clinica" />
      <div id="instructions">
        <p>Fazer login no WhatsApp usando o código QR</p>
        <ol>
          <li>Abra o WhatsApp no seu telefone.</li>
          <li>
            Toque em <b>Menu</b> ou <b>Configurações</b> e selecione
            <b>Dispositivos Conectados</b>.
          </li>
          <li>
            Aponte o seu telefone para esta tela para capturar o código QR.
          </li>
        </ol>
      </div>
      <div id="retryMessage">
        O QR Code está sendo gerado. <br />
        Por favor, aguarde...
      </div>

      <!-- Seção de debug para renderizar QR code direto da API -->
      <div id="debugSection" class="debug-mode" style="display: none">
        <h3>Modo de Debug</h3>
        <img id="qrDebugImage" src="" alt="QR Code de Debug" />
        <p id="debugInfo"></p>
        <button id="forceQrButton" class="btn btn-danger">Forçar Novo QR Code</button>
        <button id="refreshQrButton" class="btn">Atualizar QR Code</button>
        <div id="statusMessage" class="status-message" style="display: none;"></div>
      </div>
    </div>

    <script>
      let reloadTimer;

      // Função para obter parâmetros da URL
      function getUrlParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const pairs = queryString.split("&");

        for (let i = 0; i < pairs.length; i++) {
          const pair = pairs[i].split("=");
          params[decodeURIComponent(pair[0])] = decodeURIComponent(
            pair[1] || ""
          );
        }

        return params;
      }
      
      // Função para mostrar mensagem de status
      function showStatusMessage(message, type) {
        const statusElement = document.getElementById("statusMessage");
        statusElement.textContent = message;
        statusElement.className = "status-message";
        
        if (type === "success") {
          statusElement.classList.add("status-success");
        } else if (type === "error") {
          statusElement.classList.add("status-error");
        } else if (type === "warning") {
          statusElement.classList.add("status-warning");
        }
        
        statusElement.style.display = "block";
        
        // Esconder a mensagem após 5 segundos
        setTimeout(() => {
          statusElement.style.display = "none";
        }, 5000);
      }

      // Verifica se estamos no modo de debug
      const params = getUrlParams();
      const isDebugMode = window.location.pathname.includes("/debug");

      if (isDebugMode) {
        document.getElementById("debugSection").style.display = "block";
        document.getElementById("loader").style.display = "none";
        document.getElementById("instructions").style.display = "none";

        // Extrair o ID da URL
        const pathParts = window.location.pathname.split("/");
        const idIndex = pathParts.indexOf("debug") + 1;
        const id = idIndex < pathParts.length ? pathParts[idIndex] : "";

        if (id) {
          // Função para carregar o QR code
          function loadDebugQRCode(forceNew = false) {
            // Mostrar loader
            document.getElementById("qrDebugImage").style.display = "none";
            document.getElementById("loader").style.display = "block";
            document.getElementById("debugInfo").textContent = "Carregando QR code...";
            
            // Construir a URL da API
            let apiUrl = `/api/whatsapp/qr/${id}`;
            if (forceNew) {
              apiUrl += "?force=true";
            }
            
            // Fazer a requisição para a API
            fetch(apiUrl)
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`Erro na requisição: ${response.status}`);
                }
                return response.json();
              })
              .then((data) => {
                // Esconder loader
                document.getElementById("loader").style.display = "none";
                
                if (data.status === "success" && data.qrCode) {
                  // Mostrar QR code
                  document.getElementById("qrDebugImage").src = data.qrCode;
                  document.getElementById("qrDebugImage").style.display = "block";
                  document.getElementById("debugInfo").textContent = "QR code carregado com sucesso";
                  showStatusMessage("QR code carregado com sucesso", "success");
                } else if (data.status === "success" && data.authenticated) {
                  // Cliente já autenticado
                  document.getElementById("qrDebugImage").style.display = "none";
                  document.getElementById("debugInfo").textContent = "Erro: Cliente já autenticado";
                  showStatusMessage("Cliente já autenticado. Não é necessário escanear o QR code.", "warning");
                } else if (data.status === "pending") {
                  // QR code ainda não disponível
                  document.getElementById("qrDebugImage").style.display = "none";
                  document.getElementById("debugInfo").textContent = `Erro: ${data.message}`;
                  showStatusMessage(data.message, "warning");
                  
                  // Tentar novamente após 5 segundos
                  setTimeout(loadDebugQRCode, 5000);
                } else {
                  // Outro erro
                  document.getElementById("qrDebugImage").style.display = "none";
                  document.getElementById("debugInfo").textContent = `Erro: ${data.message || "QR code não disponível"}`;
                  showStatusMessage(data.message || "QR code não disponível", "error");
                }
              })
              .catch((error) => {
                // Esconder loader
                document.getElementById("loader").style.display = "none";
                document.getElementById("qrDebugImage").style.display = "none";
                document.getElementById("debugInfo").textContent = `Erro ao carregar QR code: ${error.message}`;
                showStatusMessage(`Erro ao carregar QR code: ${error.message}`, "error");
              });
          }
          
          // Função para forçar um novo QR code
          function forceNewQRCode() {
            // Mostrar loader
            document.getElementById("qrDebugImage").style.display = "none";
            document.getElementById("loader").style.display = "block";
            document.getElementById("debugInfo").textContent = "Forçando geração de novo QR code...";
            showStatusMessage("Forçando geração de novo QR code...", "warning");
            
            // Fazer a requisição para a API
            fetch(`/api/whatsapp/force-qr/${id}`)
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`Erro na requisição: ${response.status}`);
                }
                return response.json();
              })
              .then((data) => {
                // Esconder loader
                document.getElementById("loader").style.display = "none";
                document.getElementById("qrDebugImage").style.display = "none";
                document.getElementById("debugInfo").textContent = data.message;
                showStatusMessage(data.message, "warning");
                
                // Tentar carregar o QR code após 5 segundos
                setTimeout(loadDebugQRCode, 5000);
              })
              .catch((error) => {
                // Esconder loader
                document.getElementById("loader").style.display = "none";
                document.getElementById("qrDebugImage").style.display = "none";
                document.getElementById("debugInfo").textContent = `Erro ao forçar QR code: ${error.message}`;
                showStatusMessage(`Erro ao forçar QR code: ${error.message}`, "error");
              });
          }
          
          // Adicionar event listeners aos botões
          document.getElementById("forceQrButton").addEventListener("click", forceNewQRCode);
          document.getElementById("refreshQrButton").addEventListener("click", () => loadDebugQRCode(false));
          
          // Carregar o QR code assim que a página carregar
          window.onload = () => loadDebugQRCode(false);
        } else {
          document.getElementById("debugInfo").textContent = "ID não fornecido na URL";
          showStatusMessage("ID não fornecido na URL", "error");
        }
      } else {
        // Comportamento normal para o modo não-debug
        async function loadQRCode() {
          const clinicaId = window.location.pathname.split("/").pop();
          const qrEndpoint = `/qr-code/${clinicaId}`;

          try {
            const response = await fetch(qrEndpoint);
            if (response.ok) {
              const data = await response.json();
              if (data.authenticated) {
                document.getElementById("loader").style.display = "none";
                document.getElementById("qrCodeImage").style.display = "none";
                document.getElementById("instructions").style.display = "none";
                document.getElementById("retryMessage").style.display = "block";
                document.getElementById("retryMessage").innerHTML =
                  "Autenticado com sucesso!<br>Você pode fechar esta janela.";
                clearTimeout(reloadTimer);
              } else if (data.qrCodeUrl) {
                document.getElementById("loader").style.display = "none";
                document.getElementById("qrCodeImage").src = data.qrCodeUrl;
                document.getElementById("qrCodeImage").style.display = "block";
                document.getElementById("instructions").style.display = "block";
                document.getElementById("retryMessage").style.display = "none";
                // Recarregar após 30 segundos para obter um novo QR code se necessário
                clearTimeout(reloadTimer);
                reloadTimer = setTimeout(loadQRCode, 30000);
              } else {
                document.getElementById("loader").style.display = "block";
                document.getElementById("qrCodeImage").style.display = "none";
                document.getElementById("retryMessage").style.display = "block";
                // Tentar novamente após 5 segundos
                clearTimeout(reloadTimer);
                reloadTimer = setTimeout(loadQRCode, 5000);
              }
            } else {
              document.getElementById("loader").style.display = "none";
              document.getElementById("retryMessage").style.display = "block";
              document.getElementById("retryMessage").innerHTML =
                "Erro ao carregar o QR Code.<br>Tente novamente em alguns instantes.";
              // Tentar novamente após 10 segundos
              clearTimeout(reloadTimer);
              reloadTimer = setTimeout(loadQRCode, 10000);
            }
          } catch (error) {
            document.getElementById("loader").style.display = "none";
            document.getElementById("retryMessage").style.display = "block";
            document.getElementById("retryMessage").innerHTML =
              "Erro ao carregar o QR Code.<br>Tente novamente em alguns instantes.";
            // Tentar novamente após 10 segundos
            clearTimeout(reloadTimer);
            reloadTimer = setTimeout(loadQRCode, 10000);
          }
        }

        // Carregar o QR Code assim que a página carregar
        window.onload = loadQRCode;
      }
    </script>
  </body>
</html>
